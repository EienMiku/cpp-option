name: option CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  gcc-bench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libgmp-dev libmpfr-dev libmpc-dev

      - name: Build GCC trunk from source
        run: |
          git clone --depth 1 https://gcc.gnu.org/git/gcc.git gcc-src
          mkdir gcc-build gcc-install
          cd gcc-build
          ../gcc-src/configure \
            --prefix=$HOME/gcc-install \
            --enable-languages=c,c++ \
            --disable-multilib \
            --disable-bootstrap \
            --disable-libsanitizer \
            --disable-libgomp \
            --disable-libquadmath
          make -j$(nproc)
          make install
          echo "$HOME/gcc-install/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$HOME/gcc-install/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Verify GCC version
        run: |
          gcc --version
          g++ --version

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: Build and run unit test & benchmark (GCC)
        run: |
          xmake config --mode=release
          xmake f --toolchain=gcc --file=xmake.ci.gcc.lua --yes
          xmake --yes --file=xmake.ci.gcc.lua
          xmake run test_unit_gcc
          xmake run bench_gcc
          xmake run bench_debug_opt_gcc

      - name: List build outputs
        run: |
          find build -name "*gcc*" -type f || true
          ls -la build/ || true

      - name: Upload GCC artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gcc-binaries
          path: |
            build/linux/*/release/bench_debug_opt_gcc.sym
            build/linux/*/release/bench_debug_opt_gcc
            build/linux/*/release/bench_gcc
            build/linux/*/release/test_unit_gcc
          if-no-files-found: warn

  clang-bench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Build LLVM trunk from source
        run: |
          git clone --depth 1 https://github.com/llvm/llvm-project.git
          cd llvm-project
          cmake -S llvm -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_PROJECTS="clang;lld" \
            -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi" \
            -DCMAKE_INSTALL_PREFIX=$HOME/llvm-install \
            -DLLVM_TARGETS_TO_BUILD="X86" \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF
          cmake --build build -j$(nproc) --target install
          echo "$HOME/llvm-install/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$HOME/llvm-install/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Verify Clang version
        run: |
          clang --version
          clang++ --version
          lld --version

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: Build and run unit test & benchmark (Clang/libc++)
        run: |
          xmake config --mode=release
          xmake f --toolchain=clang --file=xmake.ci.clang.lua --yes
          xmake --yes --file=xmake.ci.clang.lua
          xmake run test_unit_clang
          xmake run bench_clang
          xmake run bench_debug_opt_clang

      - name: List build outputs
        run: |
          find build -name "*clang*" -type f || true
          ls -la build/ || true

      - name: Upload Clang artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clang-binaries
          path: |
            build/linux/*/release/bench_debug_opt_clang.sym
            build/linux/*/release/bench_debug_opt_clang
            build/linux/*/release/bench_clang
            build/linux/*/release/test_unit_clang
          if-no-files-found: warn

  # it seems that msvc does not support the ftm of deducing this while cppreference says it is supported
  # msvc-bench:
  #   runs-on: windows-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install xmake
  #       uses: xmake-io/github-action-setup-xmake@v1
  #     - name: Build and run unit test & benchmark (MSVC)
  #       run: |
  #         xmake require --yes gtest benchmark
  #         xmake f --toolchain=msvc --file=xmake.ci.windows.lua
  #         xmake --yes --file=xmake.ci.windows.lua
  #         xmake run test_unit_msvc
  #         xmake run bench_msvc