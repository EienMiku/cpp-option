name: option CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  gcc-bench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libgmp-dev libmpfr-dev libmpc-dev

      - name: Build GCC trunk from source
        run: |
          git clone --depth 1 https://gcc.gnu.org/git/gcc.git gcc-src
          mkdir gcc-build gcc-install
          cd gcc-build
          ../gcc-src/configure \
            --prefix=$HOME/gcc-install \
            --enable-languages=c,c++ \
            --disable-multilib \
            --disable-bootstrap \
            --disable-libsanitizer \
            --disable-libgomp \
            --disable-libquadmath
          make -j$(nproc)
          make install
          echo "$HOME/gcc-install/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$HOME/gcc-install/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Verify GCC version
        run: |
          gcc --version
          g++ --version

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: Build and run unit test & benchmark (GCC)
        run: |
          xmake config --mode=release
          xmake f --toolchain=gcc --file=xmake.ci.gcc.lua --yes
          xmake --yes --file=xmake.ci.gcc.lua
          xmake run test_unit_gcc
          xmake run bench_gcc
          xmake run bench_debug_opt_gcc

      - name: List build outputs
        run: |
          find build -name "*gcc*" -type f || true
          ls -la build/ || true

      - name: Upload GCC artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gcc-binaries
          path: |
            build/linux/*/release/bench_debug_opt_gcc.sym
            build/linux/*/release/bench_debug_opt_gcc
            build/linux/*/release/bench_gcc
            build/linux/*/release/test_unit_gcc
          if-no-files-found: warn

  clang-bench:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libc++1 libc++abi1

      - name: Install LLVM 22 from GitHub releases
        run: |
          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-22.1.0-rc2/LLVM-22.1.0-rc2-Linux-X64.tar.xz
          mkdir llvm-22
          tar xf LLVM-22.1.0-rc2-Linux-X64.tar.xz -C llvm-22 --strip-components=1
          LLVM_DIR="$(pwd)/llvm-22"
          echo "$LLVM_DIR/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$LLVM_DIR/lib:$LLVM_DIR/lib/x86_64-unknown-linux-gnu:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          sudo ln -sf "$LLVM_DIR/bin/ld.lld" /usr/bin/ld

      - name: Verify Clang version
        run: |
          clang --version
          clang++ --version
          ld.lld --version

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: Build and run unit test & benchmark (Clang/libc++)
        run: |
          xmake config --mode=release
          xmake f --toolchain=clang --file=xmake.ci.clang.lua --yes
          xmake --yes --file=xmake.ci.clang.lua
          xmake run test_unit_clang
          xmake run bench_clang
          xmake run bench_debug_opt_clang

      - name: List build outputs
        run: |
          find build -name "*clang*" -type f || true
          ls -la build/ || true

      - name: Upload Clang artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clang-binaries
          path: |
            build/linux/*/release/bench_debug_opt_clang.sym
            build/linux/*/release/bench_debug_opt_clang
            build/linux/*/release/bench_clang
            build/linux/*/release/test_unit_clang
          if-no-files-found: warn

  msvc-bench:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Visual Studio 2026 Preview Build Tools
        shell: pwsh
        run: |
          Write-Host "Installing VS 2026 Preview Build Tools..."
          choco install visualstudio2026buildtools `
            --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --includeRecommended --quiet" `
            -y --ignore-package-exit-codes=3010
          Write-Host "VS 2026 Build Tools installation completed"

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: Build and run unit test & benchmark (MSVC)
        run: |
          xmake config --mode=release
          xmake f --toolchain=msvc[vs=2026] --file=xmake.ci.windows.lua --yes
          xmake --yes --file=xmake.ci.windows.lua
          xmake run test_unit_msvc
          xmake run bench_msvc

      - name: Upload MSVC artifacts
        uses: actions/upload-artifact@v4
        with:
          name: msvc-binaries
          path: |
            build/windows/*/release/bench_msvc.exe
            build/windows/*/release/test_unit_msvc.exe
          if-no-files-found: warn